<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan BSPS Jawa Timur 2026 - Cetak</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet print plugin -->
    <script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>
    <style>
        @page {
            size: A4 portrait;
            margin: 0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f1f5f9;
            color: #1e293b;
        }

        .page {
            width: 210mm;
            height: 297mm;
            margin: 0 auto;
            background: white;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 6mm 12mm;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -8mm;
            left: 0;
            right: 0;
            height: 16mm;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            clip-path: polygon(0 0, 100% 0, 100% 30%, 0 100%);
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-row {
            display: flex;
            align-items: center;
            gap: 3mm;
        }

        .logo {
            width: 9mm;
            height: 9mm;
            background: linear-gradient(135deg, #22c55e, #0ea5e9);
            border-radius: 2mm;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo svg {
            width: 5mm;
            height: 5mm;
        }

        .title {
            font-size: 5mm;
            font-weight: 800;
        }

        .subtitle {
            font-size: 2.5mm;
            color: #94a3b8;
        }

        .tahap-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            padding: 1.2mm 3mm;
            border-radius: 2mm;
            font-size: 2.5mm;
            font-weight: 600;
        }

        /* Total Stats */
        .total-section {
            position: relative;
            z-index: 2;
            padding: 0 12mm;
            margin-top: -2mm;
        }

        .total-card {
            background: white;
            border-radius: 3mm;
            padding: 3mm 5mm;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .total-item {
            flex: 1;
        }

        .total-value {
            font-size: 5mm;
            font-weight: 800;
            color: #0f172a;
        }

        .total-value span {
            font-size: 2.5mm;
            color: #64748b;
        }

        .total-label {
            font-size: 1.8mm;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3mm;
        }

        /* Map Section */
        .map-section {
            padding: 4mm 12mm 2mm;
        }

        .section-title {
            font-size: 3mm;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 2mm;
            display: flex;
            align-items: center;
            gap: 2mm;
        }

        .section-title::before {
            content: '';
            width: 1mm;
            height: 3.5mm;
            background: linear-gradient(135deg, #22c55e, #0ea5e9);
            border-radius: 0.5mm;
        }

        .map-container {
            position: relative;
            width: 100%;
            height: 70mm;
            border-radius: 3mm;
            border: 0.2mm solid #e2e8f0;
            overflow: hidden;
        }

        #printMap {
            width: 100%;
            height: 100%;
        }

        .leaflet-control-attribution {
            display: none !important;
        }

        .leaflet-control-zoom {
            display: none !important;
        }

        /* Categories */
        .categories {
            padding: 3mm 12mm;
            display: flex;
            gap: 3mm;
        }

        .category {
            flex: 1;
            border-radius: 2.5mm;
            padding: 3mm;
        }

        .cat-perdesaan {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 0.2mm solid #bbf7d0;
        }

        .cat-perkotaan {
            background: linear-gradient(135deg, #faf5ff, #f3e8ff);
            border: 0.2mm solid #e9d5ff;
        }

        .cat-pesisir {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 0.2mm solid #bae6fd;
        }

        .cat-header {
            display: flex;
            align-items: center;
            gap: 1.5mm;
            margin-bottom: 1.5mm;
        }

        .cat-icon {
            width: 5mm;
            height: 5mm;
            border-radius: 1.2mm;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5mm;
        }

        .cat-perdesaan .cat-icon {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .cat-perkotaan .cat-icon {
            background: linear-gradient(135deg, #a855f7, #9333ea);
        }

        .cat-pesisir .cat-icon {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
        }

        .cat-title {
            font-size: 3mm;
            font-weight: 700;
            color: #1e293b;
        }

        .cat-stats {
            display: flex;
            gap: 2mm;
            margin-bottom: 1.5mm;
        }

        .cat-stat {
            flex: 1;
            text-align: center;
            background: rgba(255, 255, 255, 0.7);
            padding: 1.2mm;
            border-radius: 1.2mm;
        }

        .cat-stat-value {
            font-size: 3mm;
            font-weight: 700;
        }

        .cat-perdesaan .cat-stat-value {
            color: #16a34a;
        }

        .cat-perkotaan .cat-stat-value {
            color: #9333ea;
        }

        .cat-pesisir .cat-stat-value {
            color: #0284c7;
        }

        .cat-stat-label {
            font-size: 1.5mm;
            color: #64748b;
            text-transform: uppercase;
        }

        .cat-breakdown {
            font-size: 2mm;
            max-height: 20mm;
            overflow: hidden;
        }

        .cat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.6mm 0;
            border-bottom: 0.1mm solid rgba(0, 0, 0, 0.05);
        }

        .cat-row:last-child {
            border-bottom: none;
        }

        .cat-kab {
            color: #475569;
        }

        .cat-unit {
            font-weight: 600;
        }

        /* Chart */
        .chart-section {
            flex: 1;
            padding: 3mm 12mm;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .chart-container {
            flex: 1;
            display: flex;
            gap: 3mm;
            min-height: 0;
        }

        .chart-bars {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 1.2mm;
            overflow: hidden;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 1.5mm;
        }

        .bar-label {
            width: 20mm;
            font-size: 2mm;
            color: #475569;
            text-align: right;
        }

        .bar-track {
            flex: 1;
            height: 3.5mm;
            background: #f1f5f9;
            border-radius: 0.8mm;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 0.8mm;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 1.2mm;
        }

        .bar-value {
            font-size: 1.6mm;
            font-weight: 600;
            color: white;
        }

        .chart-legend {
            width: 30mm;
            padding: 2.5mm;
            background: #f8fafc;
            border-radius: 2mm;
        }

        .legend-title {
            font-size: 2mm;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 1.5mm;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 1.2mm;
            font-size: 1.8mm;
            margin-bottom: 1.2mm;
            color: #475569;
        }

        .legend-color {
            width: 2.2mm;
            height: 2.2mm;
            border-radius: 0.4mm;
        }

        .legend-divider {
            margin-top: 2mm;
            padding-top: 1.5mm;
            border-top: 0.1mm solid #e2e8f0;
        }

        /* Footer */
        .footer {
            background: #f8fafc;
            padding: 3mm 12mm;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 0.2mm solid #e2e8f0;
        }

        .footer-left {
            font-size: 2mm;
            color: #64748b;
        }

        .footer-left strong {
            color: #1e293b;
        }

        .footer-right {
            font-size: 1.6mm;
            color: #94a3b8;
        }

        /* Print */
        .print-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #22c55e, #0ea5e9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        .print-btn:hover {
            transform: translateY(-2px);
        }

        /* Custom marker callout labels */
        .marker-callout {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .marker-callout .callout-box {
            background: white;
            border: 1px solid #cbd5e1;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 6px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
        }

        .marker-callout .callout-name {
            font-weight: 700;
            color: #1e293b;
            font-size: 5.5px;
            display: block;
        }

        .marker-callout .callout-value {
            font-weight: 800;
            font-size: 7px;
            display: block;
        }

        .marker-callout.green .callout-value {
            color: #16a34a;
        }

        .marker-callout.purple .callout-value {
            color: #9333ea;
        }

        .marker-callout.blue .callout-value {
            color: #0284c7;
        }

        .marker-callout .callout-line {
            width: 1px;
            height: 12px;
            background: #94a3b8;
        }

        .marker-callout .callout-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            border: 1px solid white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .marker-callout.green .callout-dot {
            background: #16a34a;
        }

        .marker-callout.purple .callout-dot {
            background: #9333ea;
        }

        .marker-callout.blue .callout-dot {
            background: #0284c7;
        }

        @media print {
            body {
                background: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .page {
                margin: 0;
                box-shadow: none;
            }

            .print-btn {
                display: none;
            }

            .leaflet-tile-container {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        @media screen {
            .page {
                box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
                margin: 20px auto;
            }
        }
    </style>
</head>

<body>
    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Cetak PDF</button>

    <div class="page">
        <div class="header">
            <div class="header-content">
                <div class="logo-row">
                    <div class="logo">
                        <svg viewBox="0 0 24 24" fill="none">
                            <rect x="3" y="14" width="4" height="7" rx="1" fill="white" />
                            <rect x="10" y="8" width="4" height="13" rx="1" fill="white" />
                            <rect x="17" y="3" width="4" height="18" rx="1" fill="white" />
                        </svg>
                    </div>
                    <div>
                        <div class="title">BSPS Jawa Timur 2026</div>
                        <div class="subtitle">Bantuan Stimulan Perumahan Swadaya</div>
                    </div>
                </div>
                <span class="tahap-badge">üìÖ Tahap I</span>
            </div>
        </div>

        <div class="total-section">
            <div class="total-card">
                <div class="total-item">
                    <div class="total-value" id="grandTotal">-</div>
                    <div class="total-label">Total Unit Alokasi</div>
                </div>
                <div class="total-item">
                    <div class="total-value" id="grandDesa">- <span>Lokasi</span></div>
                    <div class="total-label">Total Desa/Kelurahan</div>
                </div>
                <div class="total-item">
                    <div class="total-value" id="grandKab">- <span>Wilayah</span></div>
                    <div class="total-label">Kabupaten/Kota</div>
                </div>
            </div>
        </div>

        <div class="map-section">
            <div class="section-title">Peta Sebaran Alokasi BSPS Jawa Timur</div>
            <div class="map-container">
                <div id="printMap"></div>
            </div>
        </div>

        <div class="categories">
            <div class="category cat-perdesaan">
                <div class="cat-header">
                    <div class="cat-icon">üèòÔ∏è</div>
                    <div class="cat-title">PERDESAAN</div>
                </div>
                <div class="cat-stats">
                    <div class="cat-stat">
                        <div class="cat-stat-value" id="desa-unit">-</div>
                        <div class="cat-stat-label">Unit</div>
                    </div>
                    <div class="cat-stat">
                        <div class="cat-stat-value" id="desa-count">-</div>
                        <div class="cat-stat-label">Desa</div>
                    </div>
                </div>
                <div class="cat-breakdown" id="desa-breakdown"></div>
            </div>
            <div class="category cat-perkotaan">
                <div class="cat-header">
                    <div class="cat-icon">üèôÔ∏è</div>
                    <div class="cat-title">PERKOTAAN</div>
                </div>
                <div class="cat-stats">
                    <div class="cat-stat">
                        <div class="cat-stat-value" id="kota-unit">-</div>
                        <div class="cat-stat-label">Unit</div>
                    </div>
                    <div class="cat-stat">
                        <div class="cat-stat-value" id="kota-count">-</div>
                        <div class="cat-stat-label">Kel</div>
                    </div>
                </div>
                <div class="cat-breakdown" id="kota-breakdown"></div>
            </div>
            <div class="category cat-pesisir">
                <div class="cat-header">
                    <div class="cat-icon">üåä</div>
                    <div class="cat-title">PESISIR</div>
                </div>
                <div class="cat-stats">
                    <div class="cat-stat">
                        <div class="cat-stat-value" id="pesisir-unit">-</div>
                        <div class="cat-stat-label">Unit</div>
                    </div>
                    <div class="cat-stat">
                        <div class="cat-stat-value" id="pesisir-count">-</div>
                        <div class="cat-stat-label">Desa</div>
                    </div>
                </div>
                <div class="cat-breakdown" id="pesisir-breakdown"></div>
            </div>
        </div>

        <div class="chart-section">
            <div class="section-title">Distribusi Alokasi Per Kabupaten/Kota</div>
            <div class="chart-container">
                <div class="chart-bars" id="chartBars"></div>
                <div class="chart-legend">
                    <div class="legend-title">Keterangan</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background:#22c55e;"></div> Perdesaan
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background:#a855f7;"></div> Perkotaan
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background:#0ea5e9;"></div> Pesisir
                    </div>
                    <div class="legend-divider">
                        <div class="legend-title">Dicetak</div>
                        <div style="font-size:1.8mm; color:#475569;" id="printDate"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-left"><strong>BP3KP Jawa IV</strong><br>Jl. Gayung Kebonsari 50, Surabaya</div>
            <div class="footer-right">Dashboard BSPS Jawa Timur 2026 | Tahap I</div>
        </div>
    </div>

    <script>
        let allData = { desa: [], kota: [], pesisir: [] };
        let printMap;

        // Kabupaten center coordinates - adjusted to avoid overlap
        const kabCenters = {
            'KAB. PACITAN': { lat: -8.15, lng: 111.05 },
            'KAB. MADIUN': { lat: -7.55, lng: 111.45 },
            'KAB. NGANJUK': { lat: -7.55, lng: 111.85 },
            'KAB. BOJONEGORO': { lat: -7.18, lng: 111.85 },
            'KAB. JOMBANG': { lat: -7.48, lng: 112.18 },
            'KAB. GRESIK': { lat: -7.18, lng: 112.55 },
            'KAB. PASURUAN': { lat: -7.72, lng: 112.85 },
            'KAB. MALANG': { lat: -8.18, lng: 112.55 },
            'KOTA MALANG': { lat: -7.88, lng: 112.68 },
            'KOTA PASURUAN': { lat: -7.58, lng: 112.92 },
            'KAB. JEMBER': { lat: -8.18, lng: 113.65 },
            'KAB. SITUBONDO': { lat: -7.65, lng: 114.02 },
            'KAB. BANYUWANGI': { lat: -8.18, lng: 114.32 }
        };

        const kabTypes = {
            'KAB. PACITAN': 'green', 'KAB. MALANG': 'green', 'KAB. PASURUAN': 'green',
            'KAB. JOMBANG': 'green', 'KAB. NGANJUK': 'green', 'KAB. MADIUN': 'green',
            'KAB. BOJONEGORO': 'green', 'KAB. JEMBER': 'green', 'KAB. GRESIK': 'green',
            'KOTA MALANG': 'purple', 'KOTA PASURUAN': 'purple',
            'KAB. BANYUWANGI': 'blue', 'KAB. SITUBONDO': 'blue'
        };

        async function loadAllData() {
            try {
                const [d1, d2, d3] = await Promise.all([
                    fetch('data_desa.json').then(r => r.json()),
                    fetch('data_kota.json').then(r => r.json()),
                    fetch('data_pesisir.json').then(r => r.json())
                ]);
                allData = { desa: d1, kota: d2, pesisir: d3 };
                initMap();
                renderAll();
            } catch (e) { console.error(e); }
        }

        function initMap() {
            // Initialize Leaflet map for print
            printMap = L.map('printMap', {
                zoomControl: false,
                attributionControl: false,
                dragging: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false,
                touchZoom: false
            }).setView([-7.8, 112.5], 7);

            // Use CartoDB Positron for cleaner look
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(printMap);

            // Fit to East Java bounds - zoomed in more
            printMap.fitBounds([
                [-8.4, 110.9],
                [-7.0, 114.5]
            ], { padding: [5, 5] });
        }

        function renderAll() {
            const { desa, kota, pesisir } = allData;
            const totalUnit = desa.reduce((s, i) => s + i.j, 0) + kota.reduce((s, i) => s + i.j, 0) + pesisir.reduce((s, i) => s + i.j, 0);
            const totalLokasi = desa.length + kota.length + pesisir.length;
            const allKab = [...new Set([...desa, ...kota, ...pesisir].map(i => i.kb))];

            document.getElementById('grandTotal').textContent = totalUnit.toLocaleString('id-ID');
            document.getElementById('grandDesa').innerHTML = `${totalLokasi} <span>Lokasi</span>`;
            document.getElementById('grandKab').innerHTML = `${allKab.length} <span>Wilayah</span>`;

            renderCategory(desa, 'desa');
            renderCategory(kota, 'kota');
            renderCategory(pesisir, 'pesisir');
            renderChart();
            renderMapMarkers();
            document.getElementById('printDate').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function renderMapMarkers() {
            const { desa, kota, pesisir } = allData;
            const all = [...desa, ...kota, ...pesisir];
            const grouped = {};
            all.forEach(i => { grouped[i.kb] = (grouped[i.kb] || 0) + i.j; });

            Object.entries(grouped).forEach(([kab, unit]) => {
                const center = kabCenters[kab];
                if (!center) return;

                const type = kabTypes[kab] || 'green';
                const shortName = kab.replace('KAB. ', '').replace('KOTA ', '');

                // Create custom callout icon with leader line and dot
                const icon = L.divIcon({
                    className: 'marker-callout ' + type,
                    html: `<div class="callout-box"><span class="callout-name">${shortName}</span><span class="callout-value">${unit}</span></div><div class="callout-line"></div><div class="callout-dot"></div>`,
                    iconSize: [60, 40],
                    iconAnchor: [30, 40]
                });

                L.marker([center.lat, center.lng], { icon }).addTo(printMap);
            });

            // Force map to redraw
            setTimeout(() => printMap.invalidateSize(), 100);
        }

        function renderCategory(data, prefix) {
            const total = data.reduce((s, i) => s + i.j, 0);
            const grouped = {};
            data.forEach(i => { grouped[i.kb] = (grouped[i.kb] || 0) + i.j; });
            const sorted = Object.entries(grouped).sort((a, b) => b[1] - a[1]);

            document.getElementById(`${prefix}-unit`).textContent = total.toLocaleString('id-ID');
            document.getElementById(`${prefix}-count`).textContent = data.length;
            document.getElementById(`${prefix}-breakdown`).innerHTML = sorted.map(([kab, unit]) =>
                `<div class="cat-row"><span class="cat-kab">${kab.replace('KAB. ', '').replace('KOTA ', '')}</span><span class="cat-unit">${unit}</span></div>`
            ).join('');
        }

        function renderChart() {
            const { desa, kota, pesisir } = allData;
            const all = [...desa, ...kota, ...pesisir];
            const grouped = {};
            all.forEach(i => { grouped[i.kb] = (grouped[i.kb] || 0) + i.j; });
            const sorted = Object.entries(grouped).sort((a, b) => b[1] - a[1]);
            const max = sorted[0]?.[1] || 1;

            const colors = {
                'KAB. PACITAN': '#22c55e', 'KAB. MALANG': '#22c55e', 'KAB. PASURUAN': '#22c55e',
                'KAB. JOMBANG': '#22c55e', 'KAB. NGANJUK': '#22c55e', 'KAB. MADIUN': '#22c55e',
                'KAB. BOJONEGORO': '#22c55e', 'KAB. JEMBER': '#22c55e', 'KAB. GRESIK': '#22c55e',
                'KOTA MALANG': '#a855f7', 'KOTA PASURUAN': '#a855f7',
                'KAB. BANYUWANGI': '#0ea5e9', 'KAB. SITUBONDO': '#0ea5e9'
            };

            document.getElementById('chartBars').innerHTML = sorted.map(([kab, unit]) => {
                const pct = (unit / max * 100).toFixed(0);
                const color = colors[kab] || '#64748b';
                return `<div class="bar-row"><div class="bar-label">${kab.replace('KAB. ', '').replace('KOTA ', '')}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${color};"><span class="bar-value">${unit}</span></div></div></div>`;
            }).join('');
        }

        loadAllData();
    </script>
</body>

</html>